#!/usr/bin/env bash

usage() {
cat <<EOM
Syntax: ./$(basename $0) [options]
    
    -P <profile_name> (required) Create or open a profile
    -p <adress:port>             Specify a proxy server to use, will use localhost:8080 by default
    -c <color_name>              Specify a color to use(blue, cyan, green, yellow, orange, red, magenta, pink), no color is used by default
    -u <user_agent>              Specify an user agent to use
    
    -L                           List available profiles
    -D <profile_name>            Delete a profile
    -h                           Help
EOM
}

[ $# -eq 0 ] && { usage; exit 1; }

if [[ ! -d "$HOME/.BurpSuite/burpbrowser" ]] || [[ ! -d "$HOME/.BurpSuite/pre-wired-browser" ]]
then
  echo "Can't find the Burp browser directory, open the browser from Burp and try again"
  exit 1
fi

while getopts ':p:u:h:P:c:LD:' opt; do
  case "$opt" in
    p)
      proxyserver="$OPTARG"
      ;;
    u)
      useragent="$OPTARG"
      ;;
    P)
      profilename="$OPTARG"
      ;;
    c)
      colorname="$OPTARG"
      ;;
    L)
      listprofiles=""
      ;;
    D)
      deleteprofile="$OPTARG"
      ;;
    h)
      usage; exit 0
      ;;
    :)
      echo -e "option requires an argument.\n"; usage; exit 1
      ;;
    ?)
      echo -e "Invalid command option.\n"; usage; exit 1
      ;;
  esac
done
shift "$(($OPTIND -1))"

if [[ -z ${profilename+x} ]] && [[ ! -d "$HOME/.BurpSuite/burp-browser-profiles" ]]
then
  echo "It looks like you did not created any profile yet, run the command again with -P profile_name to create a profile"
  exit
fi

if [[ -n ${listprofiles+x} ]]
then
  echo -e "Available profiles:\n"
  find $HOME/.BurpSuite/burp-browser-profiles -mindepth 1 -maxdepth 1 -type d -printf '%f\n'
  exit
fi  

if [[ -n $deleteprofile ]] 
then
  if  [[ -d "$HOME/.BurpSuite/burp-browser-profiles/$deleteprofile" ]]
  then
    rm -rf "$HOME/.BurpSuite/burp-browser-profiles/$deleteprofile"
    exit
  else
    echo "Profile does not exist"
    exit
  fi
fi

if [[ -z ${profilename+x} ]]
then
  echo "-P profile name argument is required"
  exit
fi 

if [[ ! -d "$HOME/.BurpSuite/burp-browser-profiles_data" ]]
then
  mkdir "$HOME/.BurpSuite/burp-browser-profiles_data"
  cp -r burp-browser-profiles-theme "$HOME/.BurpSuite/burp-browser-profiles_data/burp-browser-profiles-theme" 
  cp -r burp-browser-profiles-extension "$HOME/.BurpSuite/burp-browser-profiles_data/burp-browser-profiles-extension" 
fi

if [[ ! -d "$HOME/.BurpSuite/burp-browser-profiles" ]]
then
  mkdir "$HOME/.BurpSuite/burp-browser-profiles"
fi

if [[ ! -d "$HOME/.BurpSuite/burp-browser-profiles/$profilename" ]]
then
  cp -r "$HOME/.BurpSuite/pre-wired-browser" "$HOME/.BurpSuite/burp-browser-profiles/$profilename"
  cp -r "$HOME/.BurpSuite/burp-browser-profiles_data/burp-browser-profiles-theme" "$HOME/.BurpSuite/burp-browser-profiles/$profilename/burp-browser-profiles-theme" 
  cp -r "$HOME/.BurpSuite/burp-browser-profiles_data/burp-browser-profiles-extension" "$HOME/.BurpSuite/burp-browser-profiles/$profilename/burp-browser-profiles-extension" 
fi

if [[ ! -n $proxyserver ]] || ([[ "$proxyserver" == "localhost:8080" ]] || [[ "$proxyserver" == "127.0.0.1:8080" ]])
then
  proxyserver="localhost:8080"
fi

datadir="$HOME/.BurpSuite/burp-browser-profiles/$profilename"

if [[ -n $colorname ]]
then
  case $colorname in
    "blue")
      headercolor="blue:[0,0,255]"
      ;;
    "cyan")
      headercolor="cyan:[0,255,255]"
      ;;
    "green")
      headercolor="green:[0,255,0]"
      ;;
    "yellow")
      headercolor="yellow:[255,255,0]"
      ;;
    "orange")
      headercolor="orange:[255,140,0]"
      ;;
    "red")
      headercolor="red:[255,0,0]"
      ;;
    "pink")
      headercolor="pink:[255,105,180]"
      ;;
    "magenta")
      headercolor="magenta:[128,0,128]"
  esac

  rgb_color="\"frame\" : $(echo $headercolor|cut -d":" -f 2)"
  perl -pi -e "s/^.*frame.*$/$rgb_color/" $datadir/burp-browser-profiles-theme/manifest.json

  extension_color="var color = \'$(echo $headercolor|cut -d":" -f 1)\';"
  perl -pi -e "s/^.*frame.*$/$extension_color/" $datadir/burp-browser-profiles-extension/background.js

  loadextension_arg="--load-extension=$HOME/.BurpSuite/burp-chromium-extension,$datadir/burp-browser-profiles-theme,$datadir/burp-browser-profiles-extension"
else
  if [[ -f "$datadir/Default/Preferences" ]] 
  then
    perl -pi -e 's/"theme[^}]*/"theme":{"use_system":true/' $datadir/Default/Preferences
  fi
  loadextension_arg="--load-extension=$HOME/.BurpSuite/burp-chromium-extension"
fi

if [[ -n $useragent ]]
then
  useragent_arg="--user-agent="
  useragent_arg+="$useragent"
else
  useragent_arg=""
fi

latestversion="$(ls -td -- $HOME/.BurpSuite/burpbrowser/* | head -n 1)"

$latestversion/chrome "$useragent_arg" --proxy-server=$proxyserver --proxy-bypass-list="<-loopback>" --remote-debugging-port=0 --disable-ipc-flooding-protection --disable-xss-auditor --disable-bundled-ppapi-flash --disable-plugins-discovery --disable-default-apps --disable-prerender-local-predictor --disable-save-password-bubble --disable-sync --disable-audio-output --disable-breakpad --disable-crash-reporter --disable-prerender-local-predictor --disk-cache-size=0 --disable-settings-window --disable-notifications --disable-speech-api --disable-file-system --disable-presentation-api --disable-permissions-api --disable-new-zip-unpacker --disable-media-session-api --noerrdialogs --no-experiments --no-events --no-first-run --no-default-browser-check --no-pings --no-service-autorun --media-cache-size=0 --autoplay-policy=document-user-activation-required --overscroll-history-navigation=0 --use-fake-device-for-media-stream --dbus-stub --use-mock-keychain --disable-background-networking --use-gl=angle --useangle=swiftshader-webgl --disable-features=ChromeWhatsNewUI --user-data-dir=$datadir --disable-background-networking --disable-sync --ignore-certificate-errors $loadextension_arg --enable-crashpad chrome://newtab > /dev/null 2>&1 &
